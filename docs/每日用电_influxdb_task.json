[{"apiVersion":"influxdata.com/v2alpha1","kind":"Label","metadata":{"name":"ecstatic-colden-8b0000"},"spec":{"color":"#00a3ff","name":"HNIU"}},{"apiVersion":"influxdata.com/v2alpha1","kind":"Task","metadata":{"name":"nostalgic-wing-4b0001"},"spec":{"associations":[{"kind":"Label","name":"ecstatic-colden-8b0000"}],"cron":"0 01 * * *","name":"每日用电","query":"import \"math\"\nimport \"date\"\nimport \"join\"\n\n\n\nbucket =\n    from(bucket: \"hniu\")\n        |> range(start: -3d, stop: now())\n        |> filter(fn: (r) => r[\"_measurement\"] == \"room\")\n        |> filter(fn: (r) => r[\"_field\"] == \"money\")\n        |> filter(fn: (r) => r[\"_value\"] >= 0)\n        |> filter(fn: (r) => r[\"room_id\"] !~ /^[a-zA-Z*]/)\n        |> hourSelection(start: 0, stop: 12)\n\nyesterday = date.truncate(t: -1d, unit: 1d)\n\nyester_bucket =\n    bucket\n        |> filter(fn: (r) => date.truncate(t: r._time, unit: 1d) == yesterday)\n        |> median(column: \"_value\")\n        |> map(fn: (r) => ({r with \"_time\": string(v: yesterday)}))\n\ntoday = date.truncate(t: now(), unit: 1d)\n\ntoday_bucket =\n    bucket\n        |> filter(fn: (r) => date.truncate(t: r._time, unit: 1d) == today)\n        |> median(column: \"_value\")\n        |> map(fn: (r) => ({r with \"_time\": string(v: today)}))\n\njoin.inner(\n    left: yester_bucket,\n    right: today_bucket,\n    on: (l, r) => l.room_id == r.room_id,\n    as: (l, r) => ({l with to_day_value: r._value}),\n)\n    |> fill(column: \"to_day_value\", value: 0.0)\n    |> filter(fn: (r) => r[\"to_day_value\"] != 0)\n    |> reduce(\n        fn: (r, accumulator) => ({_value: r._value - r.to_day_value}),\n        identity: {_value: 0.0},\n    )\n    |> filter(fn: (r) => r[\"_value\"] >= 0)\n    |> set(key: \"_measurement\", value: \"daily\")\n    |> set(key: \"_time\", value: \"daily\")\n    |> map(fn: (r) => ({r with \"_time\": today}))\n    |> to(bucket: \"hniu\", org: \"MochiParty\")"}}]